# IPv4 프로토콜
## IPv4가 하는 일
- 네트워크 상 데이터를 교환하기 위한 프로토콜
- 데이터가 정확하게 전달될 것을 보장하지 않는다
- 데이터의 정확성과 신뢰성은 상위 프로토콜인 TCP에서 담당

## IPv4 프로토콜의 구조
- 다른 네트워크의 특정 대상을 찾는 IPv4 프로토콜
- 총 20 Byte + @

1. 버전, 헤더의 길이 (4로 나눔), TOS (지금은 안씀), 전체의 길이
2. Identification (IP 데이터 그램을 구분하기 위해 사용), IP Flag (IP 데이터그램이 단편화 되었는지 체크), Fragmentation offset (단편화된 데이터그램의 순서)
3. Time to live (TTL / 패킷이 없어지는 시간), Protocol (상위 프로토콜의 타입), Header Checksum (헤더 필드의 오류를 검출)
4. 출발지 주소
5. 도착지 주소

<br>

# ICMP 프로토콜
## ICMP 프로토콜이 하는 일
- 통신여부를 확인 후, 오류 메시지를 전송받는데 확인

## ICMP 프로토콜의 구조
- 특정 대상과 내가 통신이 잘되는지 확인하는 프로토콜

1. Type (응답할 때 0번, 요청할 때 8번 / 목적지 도착 실패: 3번, 목적지에서 방화벽 등을 켜서 응답을 못받음: 11번 / 라우팅 테이블 수정 5번)
2. Code (잘 몰라도 됨)
3. Checksum (헤더 필드의 오류 재 확인)

<br>

# 라우팅 테이블
- 어디로 보내야 하는지 설정되어 있는 테이블
(다른 네트워크 대역을 찾으러 갈 때 필요한 지도)

## 다른 네트워크와 통신 과정
1. ICMP 요청 (요청: 8번 type)
2. IPv4 프로토콜 작성
3. Eth 프로토콜의 목적지 주소 작성 후 스위치 전달
   - 보내는 곳은 게이트웨이의 MAC주소로 기입
4. 스위치에서 공유기로 전달
5. 공유기에서 라우팅 테이블 확인 후, 다른 네트워크 대역과 통신할 수 있도록 Eth 주소 수정
   - 즉 이더넷은 네트워크 대역이 바뀔때마다 새로 작성 됨
6. 목적지 네트워크 대역의 공유기가 받을 때, 이더넷에 목적지 MAC주소 입력 됨
7. 목적지에서 ICMP 요청 (응답: 0번 type) 으로 수정 후 반환

### 라우팅 테이블 확인 명령어
- `netstat`

<br>

# IPv4 조각화
- 큰 패킷들이 적은 MTU를 갖는 링크를 통하여 전송되려면 **여러 개의 작은 패킷으로 쪼개어/조각화** 되어 전송돼야 한다

## 조각화란?
- IPv4 20byte를 제외하고 쪼갠다
   - MTU가 3300이면 3280 Byte로..
- offset은 첫번째는 0, 두번째 패킷부터 += 첫번째 데이터 // 8
- MF 은 마지막 패킷만 0이고 나머지는 1
- ICMP도 용량이 남은 마지막 패킷에만 붙인다!

### 조각화 과정
1. 데이터를 MTU에 맞게 쪼갠다
2. IPv4 (20 Byte)를 붙여서 캡슐화한다
3. 이 때 마지막 패킷은 ICMP도 붙인다
3. MTU를 통과해서 이더넷 (14 Byte)을 붙인다


