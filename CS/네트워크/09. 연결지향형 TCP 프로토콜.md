# TCP 프로토콜
## TCP 하는 일
- 전송 제어 프로토콜 (Transmission Control Protocol)
- 프로그램간 안정적으로, 순서없이, 에러없이 교환 가능
- 안정성이 필요없는 애플리케이션의 경우 UDP를 사용
- TCP는 UDP보다 안정적이고 느리지만 속도를 직접 체감하기는 어렵다.


## TCP 프로토콜의 구조
- 출발지 포트 / 도착지 포트
- Window: 데이터를 받을 수 있는 공간(TCP 버퍼 공간)이 얼마나 남아있는지 전달

### 시퀀스 넘버
-  TCP 세그먼트의 연속된 데이터 번호

### ACK
- 처음엔 0, 이후엔 받은 시퀀스넘버 + 1

### TCP 플래그
- TCP의 주된 기능이 플래그로 나누어짐

#### TCP 플래그의 종류
- 데이터의 형태
- C E **U A P R S F**

##### U(URG)
- 긴급 비트
- 우선순위가 높다
- Urgent Pointer가 어디서부터 긴급하게 처리해야하는지 알려줌

##### A (ACK)
- 승인 비트
- 응답 할 때 자주 사용됨 

##### P (PSH)
- 데이터를 계속해서 밀어 넣겠다
- 상대적 덜 중요

##### R (RST)
- 연결 과정에서 문제가 있을 때 초기화

##### S (SYN)
- 동기화 비트 (제일 중요)
- 연결을 시작할 때 무조건 사용하는 플래그

##### F (FIN)
- 종료 비트
- 연결을 끊을때 사용하는 플래그

<br>

## TCP를 이용한 통신과정
### 연결 수립 과정
- TCP를 이용한 데이터 통신을 할 때 프로세스와 프로세스를 연결하기 위해 가장 먼저 수행되는 과정

#### 3Way Handshake
1. 클라이언트가 서버에게 요청 패킷을 보냄
   - Flag = 02 / SYN
   - S:100 / A:0
2. 서버가 클라이언트의 요청을 받아들이는 패킷을 보냄
   - Flag = 12 / SYN + ACK
   - S:2000 / A:101
3. 클라이언트는 이를 최종적으로 수락하는 패킷을 보냄
   - Flag = 10 / ACK
   - S:101 / A:2001


### 데이터 송수신 과정
- 단순 TCP 패킷만을 캡슐화해서 통신하는 것이 아닌 페이로드를 포함한 패킷을 주고 받을 때의 일정한 규칙
1. 보낸 쪽에서 또 보낼 때는 SEQ번호와 ACK번호가 그대로다
   - Flag = PSH + SYN
   - S:101 / A:2001
2. 받는 쪽에서 SEQ번호는 받은 ACK번호가 된다.
3. 받는 쪽에서 ACK번호는 받는 SEQ번호 + 데이터의 크기
   - Flag = PSH + SYN
   - S:2001 / A:201

<br>

## TCP 상태전이도
### TCP 연결 상태의 변화
#### LISTEN (passive open)
- 서버쪽에서 포트번호를 사용하고 있는 상태
- 클라이언트의 요청을 응답할 수 있는 상태

#### ESTABLISHED
- 연결이 서로 수립된 상태

### 3Way-Handshake 과정에서 상태
- 클라이언트가 SYN_SENT에서 보낸다.
- 웹서버가 LISTENING 상태에서 SYN_RECEIVED 상태가 되고 다시 패킷을 보내준다
- 클라이언트는 ESTABLISHED 상태가 되고 다시 보낸다
- 웹서버도 ESTABLISHED 상태가 되며 연결 완료